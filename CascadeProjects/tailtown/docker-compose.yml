version: '3.8'

services:
  # API Gateway
  gateway:
    build:
      context: ./services/gateway
    ports:
      - "3000:3000"
    depends_on:
      - auth
      - customer
      - reservation
      - billing
      - notification
    environment:
      - NODE_ENV=production
    networks:
      - tailtown-network

  # Auth Service
  auth:
    build:
      context: ./services/auth
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://postgres:postgres@auth-db:5432/auth
    depends_on:
      - auth-db
    networks:
      - tailtown-network

  auth-db:
    image: postgres:14
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=auth
    volumes:
      - auth-db-data:/var/lib/postgresql/data
    networks:
      - tailtown-network

  # Customer Service
  customer:
    build:
      context: ./services/customer
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://postgres:postgres@customer-db:5432/customer
    depends_on:
      - customer-db
    networks:
      - tailtown-network

  customer-db:
    image: postgres:14
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=customer
    volumes:
      - customer-db-data:/var/lib/postgresql/data
    networks:
      - tailtown-network

  # Reservation Service
  reservation:
    build:
      context: ./services/reservation
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://postgres:postgres@reservation-db:5432/reservation
    depends_on:
      - reservation-db
    networks:
      - tailtown-network

  reservation-db:
    image: postgres:14
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=reservation
    volumes:
      - reservation-db-data:/var/lib/postgresql/data
    networks:
      - tailtown-network

  # Billing Service
  billing:
    build:
      context: ./services/billing
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://postgres:postgres@billing-db:5432/billing
    depends_on:
      - billing-db
    networks:
      - tailtown-network

  billing-db:
    image: postgres:14
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=billing
    volumes:
      - billing-db-data:/var/lib/postgresql/data
    networks:
      - tailtown-network

  # Notification Service
  notification:
    build:
      context: ./services/notification
    environment:
      - NODE_ENV=production
      - REDIS_URL=redis://notification-queue:6379
    depends_on:
      - notification-queue
    networks:
      - tailtown-network

  notification-queue:
    image: redis:6
    volumes:
      - notification-queue-data:/data
    networks:
      - tailtown-network

  # Frontend
  frontend:
    build:
      context: ./frontend
    ports:
      - "80:80"
    depends_on:
      - gateway
    networks:
      - tailtown-network

networks:
  tailtown-network:
    driver: bridge

volumes:
  auth-db-data:
  customer-db-data:
  reservation-db-data:
  billing-db-data:
  notification-queue-data:
