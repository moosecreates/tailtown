"use strict";(self.webpackChunktailtown_frontend=self.webpackChunktailtown_frontend||[]).push([[3029],{53029:(e,t,a)=>{a.r(t),a.d(t,{default:()=>F});var n=a(9950),r=a(78317),s=a(46639),o=a(69019),i=a(84142),c=a(249),l=a(57357),d=a(38614),h=a(28810),m=a(41413),g=a(83563),u=a(82053),p=a(74745),y=a(52472),x=a(96583),f=a(40033),A=a(28170),j=a(2235),v=a(25333),w=a(8145),C=a(2046),b=a(66592),M=a(50294),D=a(53256),k=a(14801),N=a(1673),S=a(424),E=a(31213),I=a(91367),T=a(82932),P=a(8959);const R=new class{async getChannels(){try{return(await T.Ay.get("/api/messaging/channels")).data}catch(e){return console.error("Error fetching channels:",e),this.getMockChannels()}}async getChannelMessages(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:50,a=arguments.length>2?arguments[2]:void 0;try{const n={limit:t};a&&(n.before=a);return(await T.Ay.get("/api/messaging/channels/".concat(e,"/messages"),{params:n})).data}catch(n){return console.error("Error fetching messages for channel ".concat(e,":"),n),[]}}async sendMessage(e,t,a){try{return(await T.Ay.post("/api/messaging/channels/".concat(e,"/messages"),{content:t,mentions:a})).data}catch(n){throw console.error("Error sending message to channel ".concat(e,":"),n),n}}async markChannelAsRead(e){try{await T.Ay.post("/api/messaging/channels/".concat(e,"/read"))}catch(t){console.error("Error marking channel ".concat(e," as read:"),t)}}async getUnreadCount(){try{return(await T.Ay.get("/api/messaging/unread-count")).data.unreadCount}catch(e){return console.error("Error fetching unread count:",e),0}}async getStaffDirectory(){try{return await P.Ay.getAllStaff()}catch(e){return console.error("Error fetching staff directory:",e),[]}}async getOrCreateDirectMessage(e){try{return(await T.Ay.post("/api/messaging/direct",{recipientId:e})).data}catch(t){throw console.error("Error creating direct message with staff ".concat(e,":"),t),t}}async getDirectMessageThreads(){try{return(await T.Ay.get("/api/messaging/direct")).data}catch(e){return console.error("Error fetching direct message threads:",e),[]}}async createChannel(e){try{return(await T.Ay.post("/api/messaging/channels",e)).data}catch(t){throw console.error("Error creating channel:",t),t}}async addReaction(e,t){try{await T.Ay.post("/api/messaging/messages/".concat(e,"/reactions"),{emoji:t})}catch(a){throw console.error("Error adding reaction to message ".concat(e,":"),a),a}}async removeReaction(e,t){try{await T.Ay.delete("/api/messaging/messages/".concat(e,"/reactions/").concat(t))}catch(a){throw console.error("Error removing reaction from message ".concat(e,":"),a),a}}getMockChannels(){return[{id:"1",name:"general",displayName:"General",description:"General team discussion",type:"PUBLIC",icon:"\ud83d\udcac",color:"#2196F3",isDefault:!0,isMuted:!1,unreadCount:3,lastMessage:{content:"Morning team! Ready for a great day",createdAt:new Date(Date.now()-18e5),senderId:"user1"},messageCount:156},{id:"2",name:"announcements",displayName:"Announcements",description:"Important announcements and updates",type:"PUBLIC",icon:"\ud83d\udce2",color:"#FF9800",isDefault:!0,isMuted:!1,unreadCount:1,lastMessage:{content:"Staff meeting at 2 PM today",createdAt:new Date(Date.now()-864e5),senderId:"user2"},messageCount:42},{id:"3",name:"shift-handoff",displayName:"Shift Handoff",description:"Shift handoff notes and updates",type:"PUBLIC",icon:"\ud83d\udd04",color:"#4CAF50",isDefault:!1,isMuted:!1,unreadCount:0,lastMessage:{content:"Max needs medication at 3 PM",createdAt:new Date(Date.now()-72e5),senderId:"user3"},messageCount:89},{id:"4",name:"grooming-team",displayName:"Grooming Team",description:"Grooming department communication",type:"PRIVATE",icon:"\u2702\ufe0f",color:"#9C27B0",isDefault:!1,isMuted:!1,unreadCount:0,lastMessage:{content:"Appointment schedule updated",createdAt:new Date(Date.now()-108e5),senderId:"user4"},messageCount:34},{id:"5",name:"boarding-team",displayName:"Boarding Team",description:"Boarding department communication",type:"PRIVATE",icon:"\ud83c\udfe0",color:"#00BCD4",isDefault:!1,isMuted:!1,unreadCount:2,lastMessage:{content:"New check-in at 4 PM",createdAt:new Date(Date.now()-27e5),senderId:"user5"},messageCount:67}]}};var W=a(44414);const F=()=>{const{user:e}=(0,I.As)(),[t,a]=(0,n.useState)("channels"),[T,P]=(0,n.useState)(0),[F,B]=(0,n.useState)([]),[L,O]=(0,n.useState)(null),[G,U]=(0,n.useState)([]),[z,V]=(0,n.useState)(""),[K,Y]=(0,n.useState)(!0),[_,H]=(0,n.useState)([]),[J,q]=(0,n.useState)(!1),[Q,X]=(0,n.useState)(!1),Z=(0,n.useRef)(null);(0,n.useEffect)(()=>{$(),ee()},[]),(0,n.useEffect)(()=>{L&&te(L.id)},[L]),(0,n.useEffect)(()=>{ae()},[G]);const $=async()=>{try{Y(!0);const e=await R.getChannels();B(e)}catch(e){console.error("Error fetching channels:",e)}finally{Y(!1)}},ee=async()=>{try{const t=(await R.getStaffDirectory()).filter(t=>t.id!==(null===e||void 0===e?void 0:e.id)&&t.isActive);H(t)}catch(t){console.error("Error fetching staff directory:",t)}},te=async e=>{try{const t=await R.getChannelMessages(e);U(t),await R.markChannelAsRead(e),$()}catch(t){console.error("Error fetching messages:",t)}},ae=()=>{var e;null===(e=Z.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},ne=async()=>{if(z.trim()&&L&&!Q)try{X(!0);const e=await R.sendMessage(L.id,z.trim());U(t=>[...t,e]),V(""),$()}catch(e){console.error("Error sending message:",e),alert("Failed to send message. Please try again.")}finally{X(!1)}},re=(e,t)=>{P(t)},se=e=>{const t=new Date(e),a=(new Date).getTime()-t.getTime(),n=Math.floor(a/6e4),r=Math.floor(a/36e5),s=Math.floor(a/864e5);return n<1?"Just now":n<60?"".concat(n,"m ago"):r<24?"".concat(r,"h ago"):1===s?"Yesterday":s<7?"".concat(s,"d ago"):t.toLocaleDateString()};if(K)return(0,W.jsxs)(r.A,{children:[(0,W.jsx)(S.i,{title:"Team Chat",showNotifications:!0}),(0,W.jsx)(r.A,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"50vh"},children:(0,W.jsx)(s.A,{})})]});if("channels"===t){const e=F.filter(e=>!e.name.startsWith("dm-")),t=F.filter(e=>e.name.startsWith("dm-"));return(0,W.jsxs)(r.A,{sx:{pb:8},children:[(0,W.jsx)(S.i,{title:"Team Chat",showNotifications:!0}),(0,W.jsxs)(o.A,{value:T,onChange:re,variant:"fullWidth",sx:{borderBottom:1,borderColor:"divider"},children:[(0,W.jsx)(i.A,{icon:(0,W.jsx)(b.A,{}),label:"Channels"}),(0,W.jsx)(i.A,{icon:(0,W.jsx)(M.A,{}),label:"Direct"})]}),0===T&&(0,W.jsx)(c.A,{sx:{p:0},children:e.map((t,r)=>{var s;return(0,W.jsxs)(n.Fragment,{children:[(0,W.jsxs)(l.A,{onClick:()=>{O(t),a("chat")},sx:{py:2,px:2},children:[(0,W.jsx)(d.A,{children:(0,W.jsx)(h.A,{badgeContent:t.unreadCount,color:"error",max:99,children:(0,W.jsx)(m.A,{sx:{bgcolor:t.color||"primary.light",fontSize:"1.5rem"},children:t.icon||t.displayName.charAt(0)})})}),(0,W.jsx)(g.A,{primary:t.displayName,secondary:(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(u.A,{component:"span",variant:"body2",color:"text.primary",children:(null===(s=t.lastMessage)||void 0===s?void 0:s.content)||"No messages yet"}),t.lastMessage&&" \u2014 ".concat(se(t.lastMessage.createdAt))]}),primaryTypographyProps:{fontWeight:t.unreadCount>0?600:400},secondaryTypographyProps:{component:"span",variant:"body2",sx:{overflow:"hidden",textOverflow:"ellipsis",display:"-webkit-box",WebkitLineClamp:1,WebkitBoxOrient:"vertical"}}})]}),r<e.length-1&&(0,W.jsx)(p.A,{variant:"inset",component:"li"})]},t.id)})}),1===T&&(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(c.A,{sx:{p:0},children:t.map((e,r)=>{var s;return(0,W.jsxs)(n.Fragment,{children:[(0,W.jsxs)(l.A,{onClick:()=>{O(e),a("chat")},sx:{py:2,px:2},children:[(0,W.jsx)(d.A,{children:(0,W.jsx)(h.A,{badgeContent:e.unreadCount,color:"error",max:99,children:(0,W.jsx)(m.A,{sx:{bgcolor:"primary.main"},children:e.displayName.charAt(0)})})}),(0,W.jsx)(g.A,{primary:e.displayName,secondary:(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(u.A,{component:"span",variant:"body2",color:"text.primary",children:(null===(s=e.lastMessage)||void 0===s?void 0:s.content)||"No messages yet"}),e.lastMessage&&" \u2014 ".concat(se(e.lastMessage.createdAt))]}),primaryTypographyProps:{fontWeight:e.unreadCount>0?600:400},secondaryTypographyProps:{component:"span",variant:"body2",sx:{overflow:"hidden",textOverflow:"ellipsis",display:"-webkit-box",WebkitLineClamp:1,WebkitBoxOrient:"vertical"}}})]}),r<t.length-1&&(0,W.jsx)(p.A,{variant:"inset",component:"li"})]},e.id)})}),(0,W.jsx)(y.A,{color:"primary","aria-label":"new message",sx:{position:"fixed",bottom:80,right:16},onClick:()=>q(!0),children:(0,W.jsx)(D.A,{})}),(0,W.jsxs)(x.A,{open:J,onClose:()=>q(!1),fullWidth:!0,maxWidth:"sm",children:[(0,W.jsx)(f.A,{children:"Start a Conversation"}),(0,W.jsx)(A.A,{children:(0,W.jsx)(c.A,{children:_.map(e=>(0,W.jsxs)(l.A,{onClick:()=>(async e=>{try{Y(!0),q(!1);const t=await R.getOrCreateDirectMessage(e.id);O(t),a("chat"),await te(t.id)}catch(t){console.error("Error starting direct message:",t),alert("Failed to start conversation. Please try again.")}finally{Y(!1)}})(e),children:[(0,W.jsx)(d.A,{children:(0,W.jsxs)(m.A,{sx:{bgcolor:"primary.main"},children:[e.firstName.charAt(0),e.lastName.charAt(0)]})}),(0,W.jsx)(g.A,{primary:"".concat(e.firstName," ").concat(e.lastName),secondary:e.position||e.role})]},e.id))})})]})]}),(0,W.jsx)(E.l,{})]})}return(0,W.jsxs)(r.A,{sx:{display:"flex",flexDirection:"column",height:"100vh",pb:0},children:[(0,W.jsxs)(j.A,{elevation:1,sx:{p:2,display:"flex",alignItems:"center",borderRadius:0},children:[(0,W.jsx)(v.A,{edge:"start",onClick:()=>{O(null),U([]),a("channels")},sx:{mr:1},children:(0,W.jsx)(k.A,{})}),(0,W.jsx)(m.A,{sx:{bgcolor:(null===L||void 0===L?void 0:L.color)||"primary.light",mr:2,fontSize:"1.2rem"},children:(null===L||void 0===L?void 0:L.icon)||(null===L||void 0===L?void 0:L.displayName.charAt(0))}),(0,W.jsxs)(r.A,{sx:{flexGrow:1},children:[(0,W.jsx)(u.A,{variant:"h6",sx:{fontWeight:600},children:null===L||void 0===L?void 0:L.displayName}),(null===L||void 0===L?void 0:L.description)&&(0,W.jsx)(u.A,{variant:"caption",color:"text.secondary",children:L.description})]})]}),(0,W.jsxs)(r.A,{sx:{flexGrow:1,overflowY:"auto",p:2,backgroundColor:"#f5f5f5"},children:[G.map(t=>{const a=t.senderId===(null===e||void 0===e?void 0:e.id),n="".concat(t.sender.firstName," ").concat(t.sender.lastName);return(0,W.jsxs)(r.A,{sx:{display:"flex",justifyContent:a?"flex-end":"flex-start",mb:2},children:[!a&&(0,W.jsxs)(m.A,{sx:{width:32,height:32,mr:1,fontSize:"0.875rem",bgcolor:"secondary.main"},children:[t.sender.firstName.charAt(0),t.sender.lastName.charAt(0)]}),(0,W.jsxs)(r.A,{sx:{maxWidth:"70%"},children:[!a&&(0,W.jsx)(u.A,{variant:"caption",sx:{ml:1,color:"text.secondary"},children:n}),(0,W.jsx)(j.A,{elevation:1,sx:{p:1.5,backgroundColor:a?"primary.main":"white",color:a?"white":"text.primary",borderRadius:2,borderTopLeftRadius:a?2:0,borderTopRightRadius:a?0:2},children:(0,W.jsx)(u.A,{variant:"body2",sx:{whiteSpace:"pre-wrap"},children:t.content})}),(0,W.jsx)(u.A,{variant:"caption",sx:{ml:1,color:"text.secondary",display:"block",mt:.5},children:new Date(t.createdAt).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})})]})]},t.id)}),(0,W.jsx)("div",{ref:Z})]}),(0,W.jsx)(j.A,{elevation:3,sx:{p:1.5,borderRadius:0,borderTop:1,borderColor:"divider"},children:(0,W.jsx)(w.A,{fullWidth:!0,multiline:!0,maxRows:4,placeholder:"Type a message...",value:z,onChange:e=>V(e.target.value),onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),ne())},disabled:Q,InputProps:{endAdornment:(0,W.jsx)(C.A,{position:"end",children:(0,W.jsx)(v.A,{color:"primary",onClick:ne,disabled:!z.trim()||Q,children:(0,W.jsx)(N.A,{})})})},sx:{"& .MuiOutlinedInput-root":{borderRadius:3}}})})]})}}}]);