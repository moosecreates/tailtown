"use strict";(self.webpackChunktailtown_frontend=self.webpackChunktailtown_frontend||[]).push([[3563],{53563:(e,t,n)=>{n.r(t),n.d(t,{default:()=>B});var a=n(9950),r=n(28429),s=n(62999),i=n(2235),o=n(82053),c=n(65429),d=n(10226),l=n(78317),u=n(60899),h=n(74745),x=n(16497),p=n(93038),m=n(46639),v=n(63189),A=n(90845),j=n(2831),y=n(1320),g=n(15769),f=n(69780),b=n(9213),C=n(21671),I=n(34075),S=n(44414);const P=e=>{let{taxRate:t}=e;const{state:n}=(0,j.U)(),r=n.items.reduce((e,t)=>{let n=t.price||0;return t.addOns&&t.addOns.length>0&&(n+=t.addOns.reduce((e,t)=>e+t.price*t.quantity,0)),e+n},0),s=r*t,i=r+s;return(0,S.jsx)(y.A,{children:(0,S.jsxs)(g.A,{children:[(0,S.jsx)(f.A,{children:(0,S.jsxs)(b.A,{children:[(0,S.jsx)(C.A,{children:"Item"}),(0,S.jsx)(C.A,{children:"Type"}),(0,S.jsx)(C.A,{children:"Details"}),(0,S.jsx)(C.A,{align:"right",children:"Price"})]})}),(0,S.jsxs)(I.A,{children:[n.items.map(e=>(0,S.jsxs)(a.Fragment,{children:[(0,S.jsxs)(b.A,{children:[(0,S.jsx)(C.A,{children:e.serviceName||"Service"}),(0,S.jsx)(C.A,{children:"Service"}),(0,S.jsx)(C.A,{children:e.petName?"for ".concat(e.petName):"-"}),(0,S.jsxs)(C.A,{align:"right",children:["$",(e.price||0).toFixed(2)]})]}),e.addOns&&e.addOns.map((t,n)=>(0,S.jsxs)(b.A,{children:[(0,S.jsxs)(C.A,{sx:{pl:4},children:["+ ",t.name]}),(0,S.jsx)(C.A,{children:"Add-on"}),(0,S.jsxs)(C.A,{children:["Qty: ",t.quantity]}),(0,S.jsxs)(C.A,{align:"right",children:["$",(t.price*t.quantity).toFixed(2)]})]},"".concat(e.id,"-addon-").concat(n)))]},e.id)),(0,S.jsxs)(b.A,{children:[(0,S.jsx)(C.A,{colSpan:3,children:"Subtotal"}),(0,S.jsxs)(C.A,{align:"right",children:["$",r.toFixed(2)]})]}),(0,S.jsxs)(b.A,{children:[(0,S.jsxs)(C.A,{colSpan:3,children:["Tax (",(100*t).toFixed(2),"%)"]}),(0,S.jsxs)(C.A,{align:"right",children:["$",s.toFixed(2)]})]}),(0,S.jsxs)(b.A,{children:[(0,S.jsx)(C.A,{colSpan:3,children:(0,S.jsx)(o.A,{variant:"subtitle1",fontWeight:"bold",children:"Total"})}),(0,S.jsx)(C.A,{align:"right",children:(0,S.jsxs)(o.A,{variant:"subtitle1",fontWeight:"bold",children:["$",i.toFixed(2)]})})]})]})]})})};var w=n(25979),k=n(19647),F=n(70006),D=n(23266),q=n(8145),E=n(2046),O=n(24516);const R=e=>{let{paymentMethod:t,onPaymentMethodChange:n,paymentAmount:r,onPaymentAmountChange:s,totalAmount:i}=e;const[o,c]=(0,a.useState)(""),[d,h]=(0,a.useState)(""),[x,p]=(0,a.useState)(""),[m,v]=(0,a.useState)("");return(0,a.useEffect)(()=>{t&&"undefined"!==t&&["cash","credit_card","check","account"].includes(t)||setTimeout(()=>n("cash"),0)},[t,n]),(0,S.jsx)(l.A,{children:(0,S.jsxs)(u.Ay,{container:!0,spacing:3,children:[(0,S.jsx)(u.Ay,{item:!0,xs:12,md:6,children:(0,S.jsxs)(w.A,{fullWidth:!0,required:!0,children:[(0,S.jsx)(k.A,{id:"payment-method-label",children:"Payment Method"}),(0,S.jsxs)(F.A,{labelId:"payment-method-label",id:"payment-method",value:t||"cash",defaultValue:"cash",label:"Payment Method",onChange:e=>n(e.target.value),children:[(0,S.jsx)(D.A,{value:"cash",children:"Cash"}),(0,S.jsx)(D.A,{value:"credit_card",children:"Credit Card"}),(0,S.jsx)(D.A,{value:"check",children:"Check"}),(0,S.jsx)(D.A,{value:"account",children:"Account"})]})]})}),(0,S.jsx)(u.Ay,{item:!0,xs:12,md:6,children:(0,S.jsx)(q.A,{label:"Payment Amount",type:"number",value:r.toFixed(2),onChange:e=>{const t=parseFloat(parseFloat(e.target.value).toFixed(2));s(t)},inputProps:{step:.01},fullWidth:!0,required:!0,InputProps:{startAdornment:(0,S.jsx)(E.A,{position:"start",children:"$"})},helperText:r<i?"Remaining balance: $".concat((i-r).toFixed(2)):r>i?"Change due: $".concat((r-i).toFixed(2)):"Payment amount matches total"})}),"credit_card"===t&&(0,S.jsxs)(S.Fragment,{children:[(0,S.jsx)(u.Ay,{item:!0,xs:12,children:(0,S.jsx)(q.A,{label:"Card Number",placeholder:"**** **** **** ****",value:o,onChange:e=>c(e.target.value),fullWidth:!0,required:!0,inputProps:{maxLength:19,pattern:"[0-9\\s]{13,19}"}})}),(0,S.jsx)(u.Ay,{item:!0,xs:12,md:6,children:(0,S.jsx)(q.A,{label:"Expiration Date",placeholder:"MM/YY",value:d,onChange:e=>h(e.target.value),fullWidth:!0,required:!0,inputProps:{maxLength:5}})}),(0,S.jsx)(u.Ay,{item:!0,xs:12,md:6,children:(0,S.jsx)(q.A,{label:"CVV",placeholder:"***",value:x,onChange:e=>p(e.target.value),fullWidth:!0,required:!0,type:"password",inputProps:{maxLength:4}})})]}),"check"===t&&(0,S.jsx)(u.Ay,{item:!0,xs:12,children:(0,S.jsx)(q.A,{label:"Check Number",value:m,onChange:e=>v(e.target.value),fullWidth:!0,required:!0})}),"account"===t&&(0,S.jsx)(u.Ay,{item:!0,xs:12,children:(0,S.jsx)(O.A,{children:"The full amount will be charged to the customer's account."})})]})})};var T=n(69179),N=n(71812),W=n(45295),$=n(99061),M=n(73759),U=n(7084);const _=e=>{let{customerId:t,subtotal:n,serviceIds:r,onCouponApplied:s,onCouponRemoved:u,appliedCoupon:h}=e;const[x,p]=(0,a.useState)(""),[v,A]=(0,a.useState)(!1),[j,y]=(0,a.useState)(null),g=async()=>{y(null);const e=$.U.validateCouponCode(x);if(e.isValid){A(!0);try{const e={code:x.toUpperCase().trim(),customerId:t,subtotal:n,serviceIds:r},a=await $.U.validateCoupon(e);if(!a.isValid)return y(a.error||"Invalid coupon code"),void A(!1);const i=await $.U.getCouponByCode(x.toUpperCase().trim()),{discountAmount:o}=$.U.calculateDiscount(i,n);s(i,o),p(""),y(null)}catch(o){var a,i;y((null===(a=o.response)||void 0===a||null===(i=a.data)||void 0===i?void 0:i.message)||"Failed to apply coupon")}finally{A(!1)}}else y(e.error||"Invalid coupon code")},f=()=>{u(),p(""),y(null)};if(h){const{discountAmount:e,finalPrice:t}=$.U.calculateDiscount(h,n);return(0,S.jsx)(i.A,{elevation:2,sx:{p:2,bgcolor:"success.light",color:"success.contrastText"},children:(0,S.jsxs)(l.A,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[(0,S.jsxs)(l.A,{display:"flex",alignItems:"center",gap:1,children:[(0,S.jsx)(M.A,{}),(0,S.jsxs)(l.A,{children:[(0,S.jsxs)(o.A,{variant:"subtitle2",fontWeight:"bold",children:["Coupon Applied: ",h.code]}),(0,S.jsx)(o.A,{variant:"body2",children:h.description}),(0,S.jsxs)(o.A,{variant:"body2",fontWeight:"bold",sx:{mt:.5},children:["You save: $",e.toFixed(2)]})]})]}),(0,S.jsx)(d.A,{variant:"outlined",size:"small",onClick:f,sx:{color:"success.contrastText",borderColor:"success.contrastText"},children:"Remove"})]})})}return(0,S.jsxs)(l.A,{children:[(0,S.jsxs)(l.A,{display:"flex",gap:1,alignItems:"flex-start",children:[(0,S.jsx)(q.A,{fullWidth:!0,size:"small",label:"Coupon Code",placeholder:"Enter coupon code",value:x,onChange:e=>{p(e.target.value.toUpperCase()),y(null)},onKeyPress:e=>{"Enter"===e.key&&g()},disabled:v,error:!!j,InputProps:{startAdornment:(0,S.jsx)(U.A,{sx:{mr:1,color:"action.active"}})}}),(0,S.jsx)(d.A,{variant:"contained",onClick:g,disabled:v||!x.trim(),sx:{minWidth:100},children:v?(0,S.jsx)(m.A,{size:24}):"Apply"})]}),j&&(0,S.jsx)(c.A,{severity:"error",sx:{mt:1},children:j}),(0,S.jsx)(o.A,{variant:"caption",color:"text.secondary",sx:{mt:1,display:"block"},children:"Have a coupon? Enter it above to get a discount on your booking."})]})},B=()=>{var e;const t=(0,r.Zp)(),{state:n,clearCart:y}=(0,j.U)(),[g,f]=(0,a.useState)(!1),[b,C]=(0,a.useState)(!1),[I,w]=(0,a.useState)(null),[k,F]=(0,a.useState)("cash"),[D,q]=(0,a.useState)(0),[E,O]=(0,a.useState)(!1),[M,U]=(0,a.useState)(null),[B,V]=(0,a.useState)(0),z=n.items;(0,a.useEffect)(()=>{0!==z.length||b||t("/calendar")},[z,t,b]);const Y=z.reduce((e,t)=>{let n=t.price||0;return t.addOns&&t.addOns.length>0&&(n+=t.addOns.reduce((e,t)=>e+t.price*(t.quantity||1),0)),e+n},0),L=.0744,G=Math.max(0,Y-B),H=G*L,J=G+H;(0,a.useEffect)(()=>{q(parseFloat(J.toFixed(2)))},[J]);const K=()=>{t(-1)};return b?(0,S.jsx)(s.A,{maxWidth:"md",sx:{py:4},children:(0,S.jsxs)(i.A,{elevation:3,sx:{p:4,textAlign:"center"},children:[(0,S.jsx)(o.A,{variant:"h4",color:"primary",gutterBottom:!0,children:"Payment Successful!"}),(0,S.jsx)(c.A,{severity:"success",sx:{my:3},children:"Your reservation has been confirmed. Thank you for your business!"}),(0,S.jsx)(o.A,{variant:"body1",paragraph:!0,children:"A confirmation email has been sent to your registered email address."}),(0,S.jsx)(d.A,{variant:"contained",color:"primary",onClick:K,sx:{mt:2,mr:2},children:"View Calendar"}),(0,S.jsx)(d.A,{variant:"outlined",color:"primary",onClick:()=>t("/dashboard"),sx:{mt:2},children:"Go to Dashboard"})]})}):(0,S.jsxs)(s.A,{maxWidth:"lg",sx:{py:4},children:[(0,S.jsxs)(l.A,{sx:{mb:4,display:"flex",alignItems:"center"},children:[(0,S.jsx)(d.A,{startIcon:(0,S.jsx)(v.A,{}),onClick:K,sx:{mr:2},children:"Continue Shopping"}),(0,S.jsx)(o.A,{variant:"h4",component:"h1",children:"Checkout"})]}),I&&(0,S.jsx)(c.A,{severity:"error",sx:{mb:3},children:I}),(0,S.jsx)(u.Ay,{container:!0,spacing:3,children:(0,S.jsx)(u.Ay,{item:!0,xs:12,children:(0,S.jsxs)(i.A,{elevation:2,sx:{p:3,mb:3},children:[(0,S.jsx)(o.A,{variant:"h6",gutterBottom:!0,children:"Order Summary"}),(0,S.jsx)(h.A,{sx:{mb:2}}),(0,S.jsx)(P,{taxRate:L}),M&&B>0&&(0,S.jsxs)(l.A,{sx:{mt:2,p:2,bgcolor:"success.light",borderRadius:1},children:[(0,S.jsxs)(o.A,{variant:"body2",color:"success.dark",children:[(0,S.jsxs)("strong",{children:["Coupon Discount (",M.code,"):"]})," -$",B.toFixed(2)]}),(0,S.jsxs)(o.A,{variant:"body2",color:"success.dark",children:[(0,S.jsx)("strong",{children:"New Subtotal:"})," $",G.toFixed(2)]}),(0,S.jsxs)(o.A,{variant:"body2",color:"success.dark",children:[(0,S.jsxs)("strong",{children:["Tax (",(100*L).toFixed(2),"%):"]})," $",H.toFixed(2)]}),(0,S.jsx)(h.A,{sx:{my:1}}),(0,S.jsxs)(o.A,{variant:"h6",color:"success.dark",children:[(0,S.jsx)("strong",{children:"Total:"})," $",J.toFixed(2)]})]})]})})}),(0,S.jsx)(u.Ay,{container:!0,spacing:3,children:(0,S.jsx)(u.Ay,{item:!0,xs:12,children:(0,S.jsxs)(i.A,{elevation:2,sx:{p:3,mb:3},children:[(0,S.jsx)(o.A,{variant:"h6",gutterBottom:!0,children:"Promo Code"}),(0,S.jsx)(h.A,{sx:{mb:2}}),(0,S.jsx)(_,{customerId:(null===(e=z[0])||void 0===e?void 0:e.customerId)||"",subtotal:Y,serviceIds:z.map(e=>e.serviceId).filter(Boolean),onCouponApplied:(e,t)=>{U(e),V(t)},onCouponRemoved:()=>{U(null),V(0)},appliedCoupon:M||void 0})]})})}),(0,S.jsx)(u.Ay,{container:!0,spacing:3,children:(0,S.jsx)(u.Ay,{item:!0,xs:12,children:(0,S.jsxs)(i.A,{elevation:2,sx:{p:3},children:[(0,S.jsx)(o.A,{variant:"h6",gutterBottom:!0,children:"Payment Information"}),(0,S.jsx)(h.A,{sx:{mb:3}}),(0,S.jsxs)("form",{onSubmit:async e=>{if(e.preventDefault(),"credit_card"===k){const t=e.target,n=t.querySelector('[name="cardName"]'),a=t.querySelector('[name="cardNumber"]'),r=t.querySelector('[name="expiry"]'),s=t.querySelector('[name="cvv"]');if(null===n||void 0===n||!n.value||null===a||void 0===a||!a.value||null===r||void 0===r||!r.value||null===s||void 0===s||!s.value)return void w("Please fill in all credit card details")}if(D<=0)w("Payment amount must be greater than zero");else if(0!==z.length){f(!0),w(null);try{var t,a;const e=[];for(const t of z){let n,a=!1;if(t.id&&t.id.startsWith("reservation-")){const e=t.id.replace("reservation-","");if(e.includes("-")&&e.length>20)try{const t=await T.u.getReservationById(e);n=null!==t&&void 0!==t&&t.data?t.data:t,a=!0}catch(I){console.error("Error fetching existing reservation:",I),n=null}}if(!n){if(!t.customerId||!t.petId||!t.serviceId||!t.startDate||!t.endDate)throw new Error("Missing required reservation data");const e={customerId:t.customerId,petId:t.petId,serviceId:t.serviceId,startDate:t.startDate.toISOString(),endDate:t.endDate.toISOString(),resourceId:t.resourceId||void 0,status:"CONFIRMED",notes:t.notes||""},a=await T.u.createReservation(e);n=null!==a&&void 0!==a&&a.data?a.data:a}e.push({reservation:n,originalItem:t,isExistingReservation:a})}const i=z[0],o=z.map(e=>({type:"SERVICE",description:"".concat(e.serviceName," for ").concat(e.petName),quantity:1,unitPrice:e.price,amount:e.price,taxable:!0,serviceId:e.serviceId}));z.forEach(e=>{e.addOns&&e.addOns.length>0&&e.addOns.forEach(e=>{o.push({type:"ADD_ON",description:"".concat(e.name," (Add-on)"),quantity:e.quantity,unitPrice:e.price,amount:e.price*e.quantity,taxable:!0,serviceId:e.id})}),e.products&&e.products.length>0&&e.products.forEach(e=>{o.push({type:"PRODUCT",description:e.name,quantity:e.quantity,unitPrice:e.price,amount:e.price*e.quantity,taxable:!0,productId:e.id})})});const c={customerId:i.customerId,reservationId:null===(t=e[0])||void 0===t||null===(a=t.reservation)||void 0===a?void 0:a.id,dueDate:new Date(Date.now()+6048e5),subtotal:Y,taxRate:L,taxAmount:H,discount:B,total:J,status:"DRAFT",notes:M?"Reservation checkout payment - Coupon ".concat(M.code," applied"):"Reservation checkout payment",lineItems:o},d=await N.p.createInvoice(c);if(null!==d&&void 0!==d&&d.id){const t={invoiceId:d.id,customerId:i.customerId,amount:D,method:k.toUpperCase(),status:"PAID",transactionId:"TXID-".concat(Date.now()),notes:"Payment processed via ".concat(k)};if(await W.M.createPayment(t),await N.p.updateInvoice(d.id,{status:"PAID"}),M&&B>0)try{var r,s;await $.U.applyCoupon(M.code,i.customerId,(null===(r=e[0])||void 0===r||null===(s=r.reservation)||void 0===s?void 0:s.id)||"",Y)}catch(I){console.error("Error recording coupon redemption:",I)}for(const{reservation:n,isExistingReservation:a}of e)if(a&&null!==n&&void 0!==n&&n.id)try{await T.u.updateReservation(n.id,{status:"CONFIRMED"})}catch(I){console.error("Error updating reservation status:",I)}}for(const t of n.items)if(t.products&&t.products.length>0)for(const e of t.products)try{const t=window.location.origin;await fetch("".concat(t,"/api/products/").concat(e.id,"/inventory/adjust"),{method:"POST",headers:{"Content-Type":"application/json","x-tenant-id":localStorage.getItem("tailtown_tenant_id")||localStorage.getItem("tenantId")||"dev"},body:JSON.stringify({quantity:-e.quantity,changeType:"SALE",reason:"Sold to customer - Invoice #".concat(d.invoiceNumber||d.id),reference:d.invoiceNumber||d.id})})}catch(I){console.error("Error deducting inventory for product ".concat(e.id,":"),I)}C(!0),y(),window.dispatchEvent(new CustomEvent("reservation-created",{detail:{reservationIds:e.map(e=>e.reservation.id),refreshCalendar:!0}})),sessionStorage.setItem("refreshCalendar","true")}catch(l){var i,o,c,d;console.error("Checkout error:",l);let e="Payment processing failed. Please try again.";null!==(i=l.response)&&void 0!==i&&null!==(o=i.data)&&void 0!==o&&o.message?e=l.response.data.message:null!==(c=l.response)&&void 0!==c&&null!==(d=c.data)&&void 0!==d&&d.error?e=l.response.data.error:l.message&&(e=l.message),w(e)}finally{f(!1)}}else w("Your cart is empty")},children:[(0,S.jsx)(R,{paymentMethod:k,onPaymentMethodChange:e=>F(e),paymentAmount:D,onPaymentAmountChange:e=>q(e),totalAmount:J}),(0,S.jsxs)(u.Ay,{container:!0,spacing:2,children:[(0,S.jsx)(u.Ay,{item:!0,xs:12,sm:6,children:(0,S.jsx)(x.A,{control:(0,S.jsx)(p.A,{checked:E,onChange:e=>O(e.target.checked),color:"primary"}),label:"Save payment information for future bookings"})}),(0,S.jsx)(u.Ay,{item:!0,xs:12,sm:6,children:(0,S.jsx)(d.A,{type:"submit",variant:"contained",color:"primary",fullWidth:!0,size:"large",disabled:g,startIcon:(0,S.jsx)(A.A,{}),children:g?(0,S.jsx)(m.A,{size:24}):"Complete Payment - $".concat(J.toFixed(2))})})]})]})]})})})]})}}}]);