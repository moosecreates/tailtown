generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "darwin-arm64"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Customer {
  id               String                  @id @default(uuid())
  tenantId         String                  @default("dev")
  email            String
  firstName        String
  lastName         String
  phone            String?
  alternatePhone   String?
  address          String?
  city             String?
  state            String?
  zipCode          String?
  notes            String?
  portalEnabled    Boolean                 @default(true)
  preferredContact ContactMethod            @default(EMAIL)
  emergencyContact String?
  emergencyPhone   String?
  vatTaxId         String?
  referralSource   String?
  tags             String[]                @default([])
  isActive         Boolean                 @default(true)
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt
  documents        Document[]
  invoices         Invoice[]
  notifications    NotificationPreference?
  payments         Payment[]
  pets             Pet[]
  reservations     Reservation[]
  groomerAppointments GroomerAppointment[] @relation("CustomerGroomerAppointments")
  groomerPreferences  GroomerPreference[]  @relation("CustomerGroomerPreferences")
  classEnrollments    ClassEnrollment[]    @relation("CustomerClassEnrollments")
  classWaitlist       ClassWaitlist[]      @relation("CustomerClassWaitlist")

  @@index([firstName, lastName], map: "customers_name_search_idx")
  @@index([email], map: "customers_email_search_idx")
  @@index([phone], map: "customers_phone_search_idx")
  @@unique([tenantId, email], map: "customers_tenant_email_unique")
  @@index([tenantId, lastName, firstName], map: "customers_tenant_name_idx")
  @@index([tenantId, email], map: "customers_tenant_email_idx")
  @@unique([tenantId, id], map: "customers_tenant_id_unique")
  @@map("customers")
}

model Pet {
  id                 String          @id @default(uuid())
  tenantId           String          @default("dev")
  name               String
  type               PetType
  breed              String?
  color              String?
  birthdate          DateTime?
  weight             Float?
  gender             Gender?
  isNeutered         Boolean         @default(false)
  microchipNumber    String?
  rabiesTagNumber    String?
  specialNeeds       String?
  foodNotes          String?
  medicationNotes    String?
  behaviorNotes      String?
  allergies          String?
  idealPlayGroup     PlayGroupType?
  vaccinationStatus  Json?
  vaccineExpirations Json?
  vaccineRecordFiles Json?           // Array of uploaded vaccine record files
  vetName            String?
  vetPhone           String?
  profilePhoto       String?
  petIcons           Json?           // Array of icon IDs for quick visual reference
  iconNotes          Json?           // Custom notes for generic flag icons
  isActive           Boolean         @default(true)
  lastCheckIn        DateTime?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  customerId         String
  checkIns           CheckIn[]
  medicalRecords     MedicalRecord[]
  owner              Customer        @relation(fields: [customerId], references: [id], onDelete: Cascade)
  reservations       Reservation[]
  groomerAppointments GroomerAppointment[] @relation("PetGroomerAppointments")
  groomerPreferences  GroomerPreference[]  @relation("PetGroomerPreferences")
  classEnrollments    ClassEnrollment[]    @relation("PetClassEnrollments")
  sessionAttendance   SessionAttendance[]  @relation("PetSessionAttendance")
  classWaitlist       ClassWaitlist[]      @relation("PetClassWaitlist")

  @@index([customerId], map: "pets_customer_id_idx")
  @@index([isActive, type], map: "pets_active_type_idx")
  @@index([lastCheckIn], map: "pets_last_checkin_idx")
  @@index([tenantId, customerId], map: "pets_tenant_customer_idx")
  @@map("pets")
}

model Reservation {
  id                 String             @id @default(uuid())
  tenantId           String             @default("dev")
  orderNumber        String?
  startDate          DateTime
  endDate            DateTime
  status             ReservationStatus  @default(PENDING)
  notes              String?
  staffNotes         String?
  checkInWindow      Int?
  isRecurring        Boolean            @default(false)
  recurringPattern   String?
  preChecked         Boolean            @default(false)
  checkInDate        DateTime?
  checkOutDate       DateTime?
  earlyDropOff       Boolean            @default(false)
  latePickup         Boolean            @default(false)
  customPickupPerson String?
  confirmedBy        String?
  cancelReason       String?
  cancelDate         DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  customerId         String
  petId              String
  serviceId          String
  resourceId         String?
  staffAssignedId    String?
  checkIns           CheckIn[]
  invoice            Invoice?
  addOnServices      ReservationAddOn[]
  customer           Customer           @relation(fields: [customerId], references: [id])
  pet                Pet                @relation(fields: [petId], references: [id])
  resource           Resource?          @relation(fields: [resourceId], references: [id])
  service            Service            @relation(fields: [serviceId], references: [id])
  staffAssigned      Staff?             @relation(fields: [staffAssignedId], references: [id])

  @@index([startDate, endDate], map: "reservations_date_range_idx")
  @@index([status, startDate], map: "reservations_status_date_idx")
  @@index([customerId, status], map: "reservations_customer_status_idx")
  @@unique([tenantId, orderNumber], map: "reservations_tenant_order_unique")
  @@index([tenantId, startDate, endDate], map: "reservations_tenant_date_range_idx")
  @@index([tenantId, status, startDate], map: "reservations_tenant_status_date_idx")
  @@index([tenantId, customerId, status], map: "reservations_tenant_customer_status_idx")
  @@unique([tenantId, id], map: "reservations_tenant_id_unique")
  @@map("reservations")
}

model Service {
  id              String             @id @default(uuid())
  tenantId        String             @default("dev")
  name            String
  description     String?
  duration        Int
  price           Float
  color           String?
  serviceCategory ServiceCategory
  isActive        Boolean            @default(true)
  requiresStaff   Boolean            @default(false)
  notes           String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  capacityLimit   Int                @default(0)
  availableAddOns AddOnService[]
  priceRules      PriceRuleService[]
  reservations    Reservation[]
  groomerAppointments GroomerAppointment[]

  @@index([tenantId, isActive], map: "services_tenant_active_idx")
  @@index([tenantId, name], map: "services_tenant_name_idx")
  @@map("services")
}

model AddOnService {
  id                String             @id @default(uuid())
  tenantId          String             @default("dev")
  name              String
  description       String?
  price             Float
  duration          Int?
  serviceId         String
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  service           Service            @relation(fields: [serviceId], references: [id])
  reservationAddOns ReservationAddOn[]

  @@index([tenantId, serviceId, isActive], map: "addon_services_tenant_service_active_idx")
  @@map("addon_services")
}

model ReservationAddOn {
  id            String       @id @default(uuid())
  tenantId      String       @default("dev")
  reservationId String
  addOnId       String
  price         Float
  notes         String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  addOn         AddOnService @relation(fields: [addOnId], references: [id])
  reservation   Reservation  @relation(fields: [reservationId], references: [id], onDelete: Cascade)

  @@index([tenantId, reservationId], map: "reservation_addons_tenant_reservation_idx")
  @@map("reservation_addons")
}

model Resource {
  id                  String                 @id @default(uuid())
  tenantId            String                 @default("dev")
  name                String
  type                ResourceType
  description         String?
  capacity            Int                    @default(1)
  isActive            Boolean                @default(true)
  notes               String?
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt
  attributes          Json?
  availability        String?
  location            String?
  maintenanceSchedule String?
  lastCleanedAt       DateTime?
  maintenanceStatus   String?
  suiteNumber         Int?
  reservations        Reservation[]
  availabilitySlots   ResourceAvailability[]

  @@index([tenantId, type, isActive], map: "resources_tenant_type_active_idx")
  @@index([tenantId, name], map: "resources_tenant_name_idx")
  @@map("resources")
}

model ResourceAvailability {
  id         String             @id @default(uuid())
  tenantId   String             @default("dev")
  resourceId String
  startTime  DateTime
  endTime    DateTime
  status     AvailabilityStatus
  reason     String?
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt
  resource   Resource           @relation(fields: [resourceId], references: [id])

  @@index([tenantId, resourceId, startTime, endTime], map: "resource_availability_tenant_range_idx")
  @@map("resource_availability")
}

model Staff {
  id                   String              @id @default(uuid())
  tenantId             String              @default("dev")
  firstName            String
  lastName             String
  email                String
  phone                String?
  role                 String
  workSchedule         Json?
  specialties          String[]            @default([])
  isActive             Boolean             @default(true)
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  department           String?
  hireDate             DateTime?
  lastLogin            DateTime?
  password             String
  position             String?
  resetToken           String?
  resetTokenExpiry     DateTime?
  address              String?
  city                 String?
  state                String?
  zipCode              String?
  groomingSkills       Json?
  maxAppointmentsPerDay Int?
  averageServiceTime   Int?
  assignedReservations Reservation[]
  availability         StaffAvailability[]
  schedules            StaffSchedule[]
  timeOff              StaffTimeOff[]
  groomerAppointments  GroomerAppointment[] @relation("GroomerAppointments")
  groomerPreferences   GroomerPreference[]  @relation("GroomerPreferences")
  groomerBreaks        GroomerBreak[]       @relation("GroomerBreaks")
  instructorClasses    TrainingClass[]      @relation("InstructorClasses")

  @@unique([tenantId, email], map: "staff_tenant_email_unique")
  @@index([tenantId, isActive], map: "staff_tenant_active_idx")
  @@map("staff")
}

model StaffAvailability {
  id             String    @id @default(uuid())
  tenantId       String    @default("dev")
  staffId        String
  dayOfWeek      Int
  startTime      String
  endTime        String
  isRecurring    Boolean   @default(true)
  effectiveFrom  DateTime?
  effectiveUntil DateTime?
  isAvailable    Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  staff          Staff     @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId, dayOfWeek], map: "staff_availability_staff_day_idx")
  @@index([dayOfWeek, isAvailable], map: "staff_availability_day_status_idx")
  @@index([tenantId, staffId, dayOfWeek], map: "staff_availability_tenant_staff_day_idx")
  @@map("staff_availability")
}

model StaffTimeOff {
  id           String        @id @default(uuid())
  tenantId     String        @default("dev")
  staffId      String
  startDate    DateTime
  endDate      DateTime
  type         TimeOffType
  status       TimeOffStatus @default(PENDING)
  reason       String?
  notes        String?
  approvedById String?
  approvedDate DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  staff        Staff         @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId, status], map: "staff_time_off_staff_status_idx")
  @@index([startDate, endDate], map: "staff_time_off_date_range_idx")
  @@index([tenantId, staffId, status], map: "staff_time_off_tenant_staff_status_idx")
  @@map("staff_time_off")
}

model StaffSchedule {
  id               String         @id @default(uuid())
  tenantId         String         @default("dev")
  staffId          String
  date             DateTime
  startTime        String
  endTime          String
  status           ScheduleStatus @default(SCHEDULED)
  notes            String?
  location         String?
  startingLocation String?
  role             String?
  createdById      String?
  updatedById      String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  staff            Staff          @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId, date], map: "staff_schedules_staff_date_idx")
  @@index([date, status])
  @@index([tenantId, staffId, date], map: "staff_schedules_tenant_staff_date_idx")
  @@map("staff_schedules")
}

model Invoice {
  id            String            @id @default(uuid())
  tenantId      String            @default("dev")
  invoiceNumber String
  customerId    String
  reservationId String?
  issueDate     DateTime          @default(now())
  dueDate       DateTime
  status        InvoiceStatus     @default(DRAFT)
  subtotal      Float
  taxRate       Float             @default(0)
  taxAmount     Float             @default(0)
  discount      Float             @default(0)
  total         Float
  notes         String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  lineItems     InvoiceLineItem[]
  customer      Customer          @relation(fields: [customerId], references: [id])
  reservation   Reservation?      @relation(fields: [tenantId, reservationId], references: [tenantId, id])
  payments      Payment[]

  @@unique([tenantId, invoiceNumber], map: "invoices_tenant_number_unique")
  @@unique([tenantId, reservationId], map: "invoices_tenant_reservation_unique")
  @@index([tenantId, customerId, issueDate], map: "invoices_tenant_customer_issue_idx")
  @@index([tenantId, status, issueDate], map: "invoices_tenant_status_issue_idx")
  @@map("invoices")
}

model InvoiceLineItem {
  id          String   @id @default(uuid())
  tenantId    String   @default("dev")
  invoiceId   String
  description String
  quantity    Int      @default(1)
  unitPrice   Float
  amount      Float
  taxable     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([tenantId, invoiceId], map: "invoice_line_items_tenant_invoice_idx")
  @@map("invoice_line_items")
}

model Payment {
  id              String        @id @default(uuid())
  tenantId        String        @default("dev")
  invoiceId       String
  customerId      String
  amount          Float
  method          PaymentMethod
  status          PaymentStatus @default(PENDING)
  transactionId   String?
  paymentDate     DateTime      @default(now())
  gatewayResponse Json?
  refundedAmount  Float         @default(0)
  refundReason    String?
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  customer        Customer      @relation(fields: [customerId], references: [id])
  invoice         Invoice       @relation(fields: [invoiceId], references: [id])

  @@index([customerId, paymentDate], map: "payments_customer_date_idx")
  @@index([status, paymentDate], map: "payments_status_date_idx")
  @@index([tenantId, customerId, paymentDate], map: "payments_tenant_customer_date_idx")
  @@index([tenantId, status, paymentDate], map: "payments_tenant_status_date_idx")
  @@map("payments")
}

model Document {
  id          String   @id @default(uuid())
  tenantId    String   @default("dev")
  customerId  String
  title       String
  description String?
  fileUrl     String
  fileType    String
  fileSize    Int
  tags        String[] @default([])
  uploaded    DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  customer    Customer @relation(fields: [customerId], references: [id])

  @@index([tenantId, customerId], map: "documents_tenant_customer_idx")
  @@map("documents")
}

model NotificationPreference {
  id                   String   @id @default(uuid())
  tenantId             String   @default("dev")
  customerId           String
  emailNotifications   Boolean  @default(true)
  smsNotifications     Boolean  @default(false)
  pushNotifications    Boolean  @default(false)
  marketingEmails      Boolean  @default(true)
  appointmentReminders Boolean  @default(true)
  checkinNotifications Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  customer             Customer @relation(fields: [tenantId, customerId], references: [tenantId, id], onDelete: Cascade)

  @@unique([tenantId, customerId], map: "notification_preferences_tenant_customer_unique")
  @@map("notification_preferences")
}

model CheckIn {
  id                  String       @id @default(uuid())
  tenantId            String       @default("dev")
  petId               String
  reservationId       String?
  checkInTime         DateTime     @default(now())
  checkOutTime        DateTime?
  checkInNotes        String?
  checkOutNotes       String?
  checkInBy           String?
  checkOutBy          String?
  belongingsChecklist Json?
  foodProvided        Boolean      @default(false)
  medicationGiven     Boolean      @default(false)
  medicationNotes     String?
  behaviorDuringStay  String?
  photosTaken         Boolean      @default(false)
  photosShared        Boolean      @default(false)
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  activities          Activity[]
  pet                 Pet          @relation(fields: [petId], references: [id])
  reservation         Reservation? @relation(fields: [reservationId], references: [id])

  @@index([checkInTime], map: "check_ins_time_idx")
  @@index([petId, checkInTime], map: "check_ins_pet_time_idx")
  @@index([tenantId, petId, checkInTime], map: "check_ins_tenant_pet_time_idx")
  @@map("check_ins")
}

model Activity {
  id           String   @id @default(uuid())
  tenantId     String   @default("dev")
  checkInId    String
  activityType String
  notes        String?
  timestamp    DateTime @default(now())
  recordedBy   String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  checkIn      CheckIn  @relation(fields: [checkInId], references: [id], onDelete: Cascade)

  @@index([tenantId, checkInId, timestamp], map: "activities_tenant_checkin_time_idx")
  @@map("activities")
}

model MedicalRecord {
  id             String    @id @default(uuid())
  tenantId       String    @default("dev")
  petId          String
  recordType     String
  recordDate     DateTime
  expirationDate DateTime?
  description    String
  veterinarian   String?
  fileUrl        String?
  verified       Boolean   @default(false)
  verifiedBy     String?
  verifiedDate   DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  pet            Pet       @relation(fields: [petId], references: [id], onDelete: Cascade)

  @@index([tenantId, petId, recordType], map: "medical_records_tenant_pet_type_idx")
  @@map("medical_records")
}

model PriceRule {
  id                String                     @id @default(uuid())
  tenantId          String                     @default("dev")
  name              String
  description       String?
  ruleType          PriceRuleType
  adjustmentType    PriceAdjustmentType        @default(DISCOUNT)
  discountType      DiscountType
  discountValue     Float
  minQuantity       Int?
  maxQuantity       Int?
  startDate         DateTime?
  endDate           DateTime?
  daysOfWeek        String?
  isActive          Boolean                    @default(true)
  priority          Int                        @default(10)
  createdAt         DateTime                   @default(now())
  updatedAt         DateTime                   @updatedAt
  serviceCategories PriceRuleServiceCategory[]
  services          PriceRuleService[]

  @@index([ruleType, isActive], map: "price_rules_type_active_idx")
  @@index([tenantId, ruleType, isActive], map: "price_rules_tenant_type_active_idx")
  @@map("price_rules")
}

model PriceRuleServiceCategory {
  id              String          @id @default(uuid())
  tenantId        String          @default("dev")
  priceRuleId     String
  serviceCategory ServiceCategory
  priceRule       PriceRule       @relation(fields: [priceRuleId], references: [id], onDelete: Cascade)

  @@unique([priceRuleId, serviceCategory])
  @@index([tenantId, priceRuleId, serviceCategory], map: "price_rule_svc_cat_tenant_idx")
  @@map("price_rule_service_categories")
}

model PriceRuleService {
  id          String    @id @default(uuid())
  tenantId    String    @default("dev")
  priceRuleId String
  serviceId   String
  priceRule   PriceRule @relation(fields: [priceRuleId], references: [id], onDelete: Cascade)
  service     Service   @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([priceRuleId, serviceId])
  @@index([tenantId, priceRuleId, serviceId], map: "price_rule_services_tenant_idx")
  @@map("price_rule_services")
}

enum PetType {
  DOG
  CAT
  BIRD
  RABBIT
  REPTILE
  OTHER
}

enum Gender {
  MALE
  FEMALE
  UNKNOWN
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  CHECKED_IN
  CHECKED_OUT
  CANCELLED
  NO_SHOW
  COMPLETED
}

enum PlayGroupType {
  SMALL_DOGS
  MEDIUM_DOGS
  LARGE_DOGS
  HIGH_ENERGY
  LOW_ENERGY
  PUPPIES
  SENIORS
  SPECIAL_NEEDS
}

enum ContactMethod {
  EMAIL
  SMS
  BOTH
  NONE
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  CASH
  CHECK
  BANK_TRANSFER
  STORE_CREDIT
  GIFT_CARD
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
  REFUNDED
}

enum ResourceType {
  KENNEL
  RUN
  SUITE
  STANDARD_SUITE
  STANDARD_PLUS_SUITE
  VIP_SUITE
  PLAY_AREA
  OUTDOOR_PLAY_YARD
  PRIVATE_PLAY_AREA
  GROOMING_TABLE
  BATHING_STATION
  DRYING_STATION
  TRAINING_ROOM
  AGILITY_COURSE
  GROOMER
  TRAINER
  ATTENDANT
  BATHER
  OTHER
}

enum AvailabilityStatus {
  AVAILABLE
  RESERVED
  MAINTENANCE
  OUT_OF_SERVICE
}

enum TimeOffType {
  VACATION
  SICK
  PERSONAL
  BEREAVEMENT
  JURY_DUTY
  OTHER
}

enum TimeOffStatus {
  PENDING
  APPROVED
  DENIED
  CANCELLED
}

enum ScheduleStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum ServiceCategory {
  DAYCARE
  BOARDING
  GROOMING
  TRAINING
  OTHER
}

enum PriceRuleType {
  DAY_OF_WEEK
  MULTI_DAY
  MULTI_PET
  SEASONAL
  PROMOTIONAL
  CUSTOM
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum PriceAdjustmentType {
  DISCOUNT    // Reduces price
  SURCHARGE   // Increases price
}

enum CouponType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum CouponStatus {
  ACTIVE
  INACTIVE
  EXPIRED
  DEPLETED
}

enum PointEarningType {
  DOLLARS_SPENT
  VISIT
  REFERRAL
  BIRTHDAY
  ANNIVERSARY
  REVIEW
  SOCIAL_SHARE
  SERVICE_SPECIFIC
}

enum RedemptionType {
  DISCOUNT_PERCENTAGE
  DISCOUNT_FIXED
  FREE_SERVICE
  FREE_ADDON
  UPGRADE
}

enum TierLevel {
  BRONZE
  SILVER
  GOLD
  PLATINUM
  DIAMOND
}

// ============================================
// COUPON SYSTEM MODELS
// ============================================

model Coupon {
  id                     String        @id @default(uuid())
  tenantId               String        @default("dev")
  code                   String
  description            String
  type                   CouponType
  discountValue          Float
  minimumPurchase        Float?
  serviceIds             String?       // JSON array of service IDs
  firstTimeCustomersOnly Boolean       @default(false)
  validFrom              DateTime
  validUntil             DateTime
  maxTotalUses           Int?
  maxUsesPerCustomer     Int           @default(1)
  currentUses            Int           @default(0)
  status                 CouponStatus  @default(ACTIVE)
  isReferralCoupon       Boolean       @default(false)
  referralCustomerId     String?
  notes                  String?
  createdBy              String?
  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @updatedAt
  usages                 CouponUsage[]

  @@unique([tenantId, code], map: "coupons_tenant_code_unique")
  @@index([tenantId, status], map: "coupons_tenant_status_idx")
  @@index([tenantId, validFrom, validUntil], map: "coupons_tenant_dates_idx")
  @@map("coupons")
}

model CouponUsage {
  id             String   @id @default(uuid())
  tenantId       String   @default("dev")
  couponId       String
  coupon         Coupon   @relation(fields: [couponId], references: [id], onDelete: Cascade)
  customerId     String
  reservationId  String
  discountAmount Float
  usedAt         DateTime @default(now())

  @@index([tenantId, couponId], map: "coupon_usage_tenant_coupon_idx")
  @@index([tenantId, customerId], map: "coupon_usage_tenant_customer_idx")
  @@map("coupon_usages")
}

// ============================================
// LOYALTY REWARDS SYSTEM MODELS
// ============================================

model LoyaltyMember {
  id                String              @id @default(uuid())
  tenantId          String              @default("dev")
  customerId        String              @unique
  currentPoints     Int                 @default(0)
  lifetimePoints    Int                 @default(0)
  currentTier       TierLevel           @default(BRONZE)
  joinedAt          DateTime            @default(now())
  lastActivityAt    DateTime            @default(now())
  transactions      PointTransaction[]
  redemptions       PointRedemption[]

  @@index([tenantId, customerId], map: "loyalty_member_tenant_customer_idx")
  @@map("loyalty_members")
}

model PointTransaction {
  id              String            @id @default(uuid())
  tenantId        String            @default("dev")
  memberId        String
  member          LoyaltyMember     @relation(fields: [memberId], references: [id], onDelete: Cascade)
  points          Int
  type            PointEarningType
  description     String
  referenceId     String?           // Reservation ID, etc.
  createdAt       DateTime          @default(now())

  @@index([tenantId, memberId], map: "point_transaction_tenant_member_idx")
  @@map("point_transactions")
}

model PointRedemption {
  id              String            @id @default(uuid())
  tenantId        String            @default("dev")
  memberId        String
  member          LoyaltyMember     @relation(fields: [memberId], references: [id], onDelete: Cascade)
  pointsRedeemed  Int
  redemptionType  RedemptionType
  value           Float
  description     String
  reservationId   String?
  redeemedAt      DateTime          @default(now())

  @@index([tenantId, memberId], map: "point_redemption_tenant_member_idx")
  @@map("point_redemptions")
}

// ============================================
// CHECKLIST SYSTEM MODELS
// ============================================

model ChecklistTemplate {
  id                  String              @id @default(uuid())
  tenantId            String              @default("dev")
  name                String
  description         String
  area                String              // KENNEL_CHECKIN, GROOMING, etc.
  isActive            Boolean             @default(true)
  items               String              // JSON array of template items
  requiredForCompletion String?           // JSON array of required item IDs
  estimatedMinutes    Int                 @default(15)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  instances           ChecklistInstance[]

  @@index([tenantId, area], map: "checklist_template_tenant_area_idx")
  @@map("checklist_templates")
}

model ChecklistInstance {
  id                  String              @id @default(uuid())
  tenantId            String              @default("dev")
  templateId          String
  template            ChecklistTemplate   @relation(fields: [templateId], references: [id], onDelete: Cascade)
  reservationId       String?
  petId               String?
  resourceId          String?
  customerId          String?
  assignedToStaffId   String?
  assignedToStaffName String?
  status              String              @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, SKIPPED
  startedAt           DateTime?
  completedAt         DateTime?
  items               String              // JSON array of instance items with values
  notes               String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  @@index([tenantId, status], map: "checklist_instance_tenant_status_idx")
  @@index([tenantId, reservationId], map: "checklist_instance_tenant_reservation_idx")
  @@index([tenantId, assignedToStaffId], map: "checklist_instance_tenant_staff_idx")
  @@map("checklist_instances")
}

// ============================================
// MULTI-TENANCY MANAGEMENT MODELS
// ============================================

model Tenant {
  id                    String       @id @default(uuid())
  
  // Business Information
  businessName          String
  subdomain             String       @unique  // e.g., "pawsinn" for pawsinn.tailtown.com
  contactName           String
  contactEmail          String       @unique
  contactPhone          String?
  address               String?
  city                  String?
  state                 String?
  zipCode               String?
  country               String       @default("US")
  
  // Account Status
  status                TenantStatus @default(TRIAL)
  isActive              Boolean      @default(true)
  isPaused              Boolean      @default(false)
  
  // Subscription & Billing
  planType              String       @default("STARTER")  // STARTER, PROFESSIONAL, ENTERPRISE
  billingEmail          String?
  maxEmployees          Int          @default(50)
  maxLocations          Int          @default(1)
  
  // Dates
  trialEndsAt           DateTime?
  subscriptionStartDate DateTime?
  subscriptionEndDate   DateTime?
  pausedAt              DateTime?
  deletedAt             DateTime?    // Soft delete
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  
  // Settings
  timezone              String       @default("America/New_York")
  currency              String       @default("USD")
  dateFormat            String       @default("MM/DD/YYYY")
  timeFormat            String       @default("12h")
  
  // Usage Tracking
  employeeCount         Int          @default(0)
  customerCount         Int          @default(0)
  reservationCount      Int          @default(0)
  storageUsedMB         Int          @default(0)
  
  // Relations
  users                 TenantUser[]
  
  @@index([subdomain])
  @@index([status, isActive])
  @@index([contactEmail])
  @@map("tenants")
}

enum TenantStatus {
  TRIAL           // Free trial period
  ACTIVE          // Paid and active
  PAUSED          // Temporarily suspended
  CANCELLED       // Subscription cancelled
  DELETED         // Soft deleted
  PENDING         // Awaiting activation
}

// Tenant Users (employees/staff who access the system)
model TenantUser {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  email       String
  password    String   // Hashed password
  firstName   String
  lastName    String
  role        UserRole @default(STAFF)
  
  isActive    Boolean  @default(true)
  lastLoginAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([tenantId, email])
  @@index([tenantId, role])
  @@index([email])
  @@map("tenant_users")
}

enum UserRole {
  SUPER_ADMIN    // Platform admin (you)
  TENANT_ADMIN   // Tenant owner/admin
  MANAGER        // Location manager
  STAFF          // Regular employee
  CUSTOMER       // Customer with login
}

// ============================================
// ADVANCED SCHEDULING MODELS
// ============================================

// Groomer-Specific Scheduling
model GroomerAppointment {
  id              String   @id @default(uuid())
  tenantId        String   @default("dev")
  reservationId   String
  groomerId       String
  serviceId       String
  petId           String
  customerId      String
  scheduledDate   DateTime
  scheduledTime   String
  duration        Int
  status          String   @default("SCHEDULED")
  actualStartTime DateTime?
  actualEndTime   DateTime?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  groomer         Staff    @relation("GroomerAppointments", fields: [groomerId], references: [id], onDelete: Cascade)
  service         Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  pet             Pet      @relation("PetGroomerAppointments", fields: [petId], references: [id], onDelete: Cascade)
  customer        Customer @relation("CustomerGroomerAppointments", fields: [customerId], references: [id], onDelete: Cascade)
  
  @@index([groomerId, scheduledDate], map: "groomer_appointments_groomer_date_idx")
  @@index([tenantId, groomerId, status], map: "groomer_appointments_tenant_groomer_status_idx")
  @@index([reservationId], map: "groomer_appointments_reservation_idx")
  @@map("groomer_appointments")
}

model GroomerPreference {
  id         String   @id @default(uuid())
  tenantId   String   @default("dev")
  customerId String
  groomerId  String
  petId      String?
  priority   Int      @default(1)
  notes      String?
  createdAt  DateTime @default(now())
  
  customer   Customer @relation("CustomerGroomerPreferences", fields: [customerId], references: [id], onDelete: Cascade)
  groomer    Staff    @relation("GroomerPreferences", fields: [groomerId], references: [id], onDelete: Cascade)
  pet        Pet?     @relation("PetGroomerPreferences", fields: [petId], references: [id], onDelete: Cascade)
  
  @@unique([tenantId, customerId, groomerId, petId], map: "groomer_preference_unique")
  @@index([customerId], map: "groomer_preferences_customer_idx")
  @@index([groomerId], map: "groomer_preferences_groomer_idx")
  @@map("groomer_preferences")
}

model GroomerBreak {
  id        String   @id @default(uuid())
  tenantId  String   @default("dev")
  groomerId String
  date      DateTime
  startTime String
  endTime   String
  type      String
  notes     String?
  createdAt DateTime @default(now())
  
  groomer   Staff    @relation("GroomerBreaks", fields: [groomerId], references: [id], onDelete: Cascade)
  
  @@index([groomerId, date], map: "groomer_breaks_groomer_date_idx")
  @@map("groomer_breaks")
}

// Multi-Week Training Classes
model TrainingClass {
  id              String   @id @default(uuid())
  tenantId        String   @default("dev")
  name            String
  description     String?
  level           String
  category        String
  instructorId    String
  maxCapacity     Int
  currentEnrolled Int      @default(0)
  
  startDate       DateTime
  endDate         DateTime
  totalWeeks      Int
  daysOfWeek      Int[]
  startTime       String
  endTime         String
  duration        Int
  
  pricePerSeries  Float
  pricePerSession Float?
  depositRequired Float?
  
  status          String   @default("SCHEDULED")
  isActive        Boolean  @default(true)
  
  minAge          Int?
  maxAge          Int?
  prerequisites   String[]
  
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  instructor      Staff           @relation("InstructorClasses", fields: [instructorId], references: [id], onDelete: Cascade)
  sessions        ClassSession[]
  enrollments     ClassEnrollment[]
  waitlist        ClassWaitlist[]
  
  @@index([tenantId, status, isActive], map: "training_classes_tenant_status_idx")
  @@index([startDate, endDate], map: "training_classes_dates_idx")
  @@index([instructorId], map: "training_classes_instructor_idx")
  @@map("training_classes")
}

model ClassSession {
  id              String   @id @default(uuid())
  tenantId        String   @default("dev")
  classId         String
  sessionNumber   Int
  scheduledDate   DateTime
  scheduledTime   String
  duration        Int
  
  status          String   @default("SCHEDULED")
  actualStartTime DateTime?
  actualEndTime   DateTime?
  
  topic           String?
  objectives      String[]
  materials       String[]
  homework        String?
  
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  class           TrainingClass      @relation(fields: [classId], references: [id], onDelete: Cascade)
  attendance      SessionAttendance[]
  
  @@index([classId, sessionNumber], map: "class_sessions_class_number_idx")
  @@index([scheduledDate, status], map: "class_sessions_date_status_idx")
  @@map("class_sessions")
}

model ClassEnrollment {
  id              String   @id @default(uuid())
  tenantId        String   @default("dev")
  classId         String
  petId           String
  customerId      String
  
  enrollmentDate  DateTime @default(now())
  status          String   @default("ENROLLED")
  
  amountPaid      Float    @default(0)
  amountDue       Float
  paymentStatus   String   @default("PENDING")
  
  sessionsAttended Int     @default(0)
  totalSessions   Int
  completionRate  Float   @default(0)
  
  certificateIssued Boolean @default(false)
  certificateDate   DateTime?
  
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  class           TrainingClass      @relation(fields: [classId], references: [id], onDelete: Cascade)
  pet             Pet                @relation("PetClassEnrollments", fields: [petId], references: [id], onDelete: Cascade)
  customer        Customer           @relation("CustomerClassEnrollments", fields: [customerId], references: [id], onDelete: Cascade)
  attendance      SessionAttendance[]
  
  @@unique([classId, petId], map: "class_enrollment_unique")
  @@index([tenantId, status], map: "class_enrollments_tenant_status_idx")
  @@index([classId], map: "class_enrollments_class_idx")
  @@index([customerId], map: "class_enrollments_customer_idx")
  @@index([petId], map: "class_enrollments_pet_idx")
  @@map("class_enrollments")
}

model SessionAttendance {
  id              String   @id @default(uuid())
  tenantId        String   @default("dev")
  sessionId       String
  enrollmentId    String
  petId           String
  
  status          String
  arrivalTime     DateTime?
  departureTime   DateTime?
  
  participationLevel String?
  behaviorRating     Int?
  progressNotes      String?
  
  homeworkCompleted  Boolean @default(false)
  homeworkNotes      String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  session         ClassSession    @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  enrollment      ClassEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  pet             Pet             @relation("PetSessionAttendance", fields: [petId], references: [id], onDelete: Cascade)
  
  @@unique([sessionId, enrollmentId], map: "session_attendance_unique")
  @@index([sessionId, status], map: "session_attendance_session_status_idx")
  @@index([enrollmentId], map: "session_attendance_enrollment_idx")
  @@map("session_attendance")
}

model ClassWaitlist {
  id           String   @id @default(uuid())
  tenantId     String   @default("dev")
  classId      String
  petId        String
  customerId   String
  position     Int
  addedDate    DateTime @default(now())
  notified     Boolean  @default(false)
  notifiedDate DateTime?
  status       String   @default("WAITING")
  
  class        TrainingClass @relation(fields: [classId], references: [id], onDelete: Cascade)
  pet          Pet           @relation("PetClassWaitlist", fields: [petId], references: [id], onDelete: Cascade)
  customer     Customer      @relation("CustomerClassWaitlist", fields: [customerId], references: [id], onDelete: Cascade)
  
  @@unique([classId, petId], map: "class_waitlist_unique")
  @@index([classId, position], map: "class_waitlist_class_position_idx")
  @@index([customerId], map: "class_waitlist_customer_idx")
  @@map("class_waitlist")
}
