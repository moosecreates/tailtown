name: Pre-Deployment Tests

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  prisma-validation:
    name: Validate Prisma Schema
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: tailtown_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies - Customer Service
        run: |
          cd services/customer
          npm ci

      - name: Check Prisma Client Generation
        run: |
          cd services/customer
          npx prisma generate
          echo "âœ… Prisma client generated successfully"

      - name: Verify Prisma Client Files
        run: |
          cd services/customer
          if [ ! -d "node_modules/@prisma/client" ]; then
            echo "âŒ Prisma client not found"
            exit 1
          fi
          echo "âœ… Prisma client files exist"

      - name: Run Database Migrations
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/tailtown_test
        run: |
          cd services/customer
          npx prisma migrate deploy
          echo "âœ… Migrations applied successfully"

      - name: Run Prisma Schema Validation Tests
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/tailtown_test
          JWT_SECRET: test-secret-key-for-testing-only
          NODE_ENV: test
        run: |
          cd services/customer
          npm test -- prisma-schema-validation.test.ts
          echo "âœ… Schema validation tests passed"

      - name: Run Service Health Tests
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/tailtown_test
          JWT_SECRET: test-secret-key-for-testing-only
          NODE_ENV: test
        run: |
          cd services/customer
          npm test -- service-health.test.ts
          echo "âœ… Service health tests passed"

  reservation-service-validation:
    name: Validate Reservation Service
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: tailtown_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies - Reservation Service
        run: |
          cd services/reservation-service
          npm ci --legacy-peer-deps

      - name: Check Prisma Client Generation
        run: |
          cd services/reservation-service
          npx prisma generate
          echo "âœ… Reservation service Prisma client generated"

      - name: Run Database Migrations
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/tailtown_test
        run: |
          cd services/reservation-service
          npx prisma migrate deploy
          echo "âœ… Reservation service migrations applied"

      - name: Build TypeScript
        run: |
          cd services/reservation-service
          npm run build
          echo "âœ… Reservation service built successfully"

  typescript-compilation:
    name: TypeScript Compilation Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Customer Service Dependencies
        run: |
          cd services/customer
          npm ci

      - name: Generate Prisma Client - Customer
        run: |
          cd services/customer
          npx prisma generate

      - name: Build Customer Service
        run: |
          cd services/customer
          npm run build
          echo "âœ… Customer service TypeScript compiled"

      - name: Install Reservation Service Dependencies
        run: |
          cd services/reservation-service
          npm ci --legacy-peer-deps

      - name: Generate Prisma Client - Reservation
        run: |
          cd services/reservation-service
          npx prisma generate

      - name: Build Reservation Service
        run: |
          cd services/reservation-service
          npm run build
          echo "âœ… Reservation service TypeScript compiled"

  deployment-readiness:
    name: Deployment Readiness Check
    runs-on: ubuntu-latest
    needs: [prisma-validation, reservation-service-validation, typescript-compilation]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check for required files
        run: |
          echo "Checking for required configuration files..."
          
          # Check ecosystem.config.js
          if [ ! -f "ecosystem.config.js" ]; then
            echo "âŒ ecosystem.config.js not found"
            exit 1
          fi
          
          # Check .env.example files
          if [ ! -f "services/customer/.env.example" ]; then
            echo "âŒ services/customer/.env.example not found"
            exit 1
          fi
          
          if [ ! -f "services/reservation-service/.env.example" ]; then
            echo "âŒ services/reservation-service/.env.example not found"
            exit 1
          fi
          
          echo "âœ… All required files present"

      - name: Validate Prisma Schema Syntax
        run: |
          cd services/customer
          npx prisma validate
          echo "âœ… Customer service schema valid"
          
          cd ../reservation-service
          npx prisma validate
          echo "âœ… Reservation service schema valid"

      - name: Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… ALL PRE-DEPLOYMENT CHECKS PASSED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âœ… Prisma schemas validated"
          echo "âœ… Prisma clients generated successfully"
          echo "âœ… Database migrations applied"
          echo "âœ… TypeScript compilation successful"
          echo "âœ… Service health tests passed"
          echo "âœ… Configuration files present"
          echo ""
          echo "ğŸš€ Ready for deployment!"
