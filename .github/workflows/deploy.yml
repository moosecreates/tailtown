name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm ci
        cd frontend && npm ci
        cd ../services/customer && npm ci
        cd ../reservation-service && npm ci
    
    - name: Generate Prisma clients
      run: |
        cd services/customer
        rm -rf node_modules/.prisma node_modules/@prisma/client
        npx prisma generate
        cd ../reservation-service
        rm -rf node_modules/.prisma node_modules/@prisma/client
        npx prisma generate
    
    - name: Build frontend
      env:
        REACT_APP_TENANT_ID: dev
        REACT_APP_API_URL: http://129.212.178.244:4004
        REACT_APP_RESERVATION_API_URL: http://129.212.178.244:4003
        DISABLE_ESLINT_PLUGIN: true
      run: |
        cd frontend
        npm run build
    
    - name: Build backend services
      run: |
        cd services/customer
        npm run build
        cd ../reservation-service
        npm run build
    
    - name: Create deployment package
      run: |
        mkdir -p deploy
        cp -r frontend/build deploy/frontend
        cp -r services/customer/dist deploy/customer
        cp -r services/customer/prisma deploy/customer/
        mkdir -p deploy/customer/node_modules/@prisma
        cp -r services/customer/node_modules/@prisma/client deploy/customer/node_modules/@prisma/
        cp -r services/reservation-service/dist deploy/reservation
        cp -r services/reservation-service/prisma deploy/reservation/
        mkdir -p deploy/reservation/node_modules/@prisma
        cp -r services/reservation-service/node_modules/@prisma/client deploy/reservation/node_modules/@prisma/
        tar -czf deploy.tar.gz deploy/
    
    - name: Deploy to Digital Ocean
      env:
        SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
        SERVER_HOST: 129.212.178.244
        SERVER_USER: root
      run: |
        # Setup SSH
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts
        
        # Upload deployment package
        scp -i ~/.ssh/deploy_key deploy.tar.gz $SERVER_USER@$SERVER_HOST:/tmp/
        
        # Deploy on server using zero-downtime script
        ssh -i ~/.ssh/deploy_key $SERVER_USER@$SERVER_HOST << 'EOF'
          cd /opt/tailtown
          
          # Backup current deployment
          tar -czf backup-$(date +%Y%m%d_%H%M%S).tar.gz frontend/build services/customer/dist services/reservation-service/dist 2>/dev/null || true
          
          # Extract new deployment
          tar -xzf /tmp/deploy.tar.gz -C /tmp/
          
          # Update files
          cp -r /tmp/deploy/frontend/* frontend/build/
          cp -r /tmp/deploy/customer/* services/customer/dist/
          cp -r /tmp/deploy/reservation/* services/reservation-service/dist/
          
          # Run database migrations with error checking
          echo "Running customer service migrations..."
          cd services/customer
          # First, try to resolve any failed migrations
          echo "Attempting to resolve failed migration..."
          npx prisma migrate resolve --rolled-back 20251023144036_add_check_in_system || echo "Migration resolve failed or not needed"
          if npx prisma migrate deploy; then
            echo "✅ Customer migrations successful"
          else
            echo "❌ Customer migrations failed"
            exit 1
          fi
          cd ../..
          
          echo "Running reservation service migrations..."
          cd services/reservation-service
          # Resolve the same failed migration in reservation service
          # Use --applied because QuestionType already exists (migration partially applied)
          echo "Attempting to resolve failed migration..."
          npx prisma migrate resolve --applied 20251023144036_add_check_in_system || echo "Migration resolve failed or not needed"
          if npx prisma migrate deploy; then
            echo "✅ Reservation migrations successful"
          else
            echo "❌ Reservation migrations failed"
            exit 1
          fi
          cd ../..
          
          # Copy generated Prisma clients from CI build to server
          echo "Copying Prisma clients from CI build..."
          # Remove parent node_modules/@prisma to force services to use their own
          rm -rf node_modules/@prisma
          
          # Copy fresh Prisma clients to each service
          cd services/customer
          if [ -d "/tmp/deploy/customer/node_modules/@prisma/client" ]; then
            rm -rf node_modules/@prisma/client
            mkdir -p node_modules/@prisma
            cp -r /tmp/deploy/customer/node_modules/@prisma/client node_modules/@prisma/
            echo "✅ Customer service Prisma client updated"
          fi
          cd ../reservation-service
          if [ -d "/tmp/deploy/reservation/node_modules/@prisma/client" ]; then
            rm -rf node_modules/@prisma/client
            mkdir -p node_modules/@prisma
            cp -r /tmp/deploy/reservation/node_modules/@prisma/client node_modules/@prisma/
            echo "✅ Reservation service Prisma client updated"
          fi
          cd ../..
          
          # Full restart after migrations and Prisma client update
          echo "Restarting services with fresh Prisma clients..."
          # Delete and restart to ensure no caching
          pm2 delete customer-service || true
          pm2 delete reservation-service || true
          pm2 start ecosystem.config.js --only customer-service
          pm2 start ecosystem.config.js --only reservation-service
          pm2 save
          echo "✅ Services restarted"
          
          # Cleanup
          rm -rf /tmp/deploy /tmp/deploy.tar.gz
          
          echo "✅ Zero-downtime deployment complete"
        EOF
    
    - name: Verify deployment
      env:
        SERVER_HOST: 129.212.178.244
      run: |
        sleep 10
        curl -f http://$SERVER_HOST:4004/health || exit 1
        curl -f http://$SERVER_HOST:4003/health || exit 1
        curl -f http://$SERVER_HOST:3000 || exit 1
    
    - name: Notify on success
      if: success()
      run: echo "✅ Deployment successful!"
    
    - name: Notify on failure
      if: failure()
      run: echo "❌ Deployment failed!"
